# AI Context - Litepie Form Builder Package

> **For AI Assistants**: This file provides structured context about the Litepie Form Builder package to help AI tools understand the codebase architecture, features, and usage patterns.

## Package Overview

**Name**: `litepie/form`  
**Type**: Laravel Form Builder Library  
**Version**: Compatible with Laravel 11+ and 12+  
**PHP**: 8.2+  
**License**: MIT  

### Purpose
A comprehensive, production-ready form builder for Laravel with advanced features including field visibility control, caching, hierarchical organization, and multi-framework UI support.

## Core Architecture

### Main Classes

```
src/
├── FormBuilder.php           # Main form builder with fluent API
├── FormManager.php           # Form lifecycle and factory management
├── FormRenderer.php          # View rendering engine
├── FormValidator.php         # Validation handler
├── Field.php                 # Abstract base field class
├── FieldFactory.php          # Field instantiation factory
├── FormServiceProvider.php   # Laravel service provider
└── helpers.php               # Global helper functions
```

### Field Organization

```
src/Fields/
├── BasicFields.php           # TextField, EmailField, PasswordField
├── ComplexFields.php         # SelectField, RadioField, CheckboxField
├── AdvancedFields.php        # FileField, ImageField, RichTextField
└── AdditionalFields.php      # DateField, TimeField, ColorField, etc.
```

## Key Features (for AI Understanding)

### 1. Fluent Form Building API

```php
// Pattern: Chainable method calls returning $this
Form::create()
    ->action('/endpoint')
    ->method('POST')
    ->add('field_name', 'field_type', ['options'])
    ->row([Field::text('name'), Field::email('email')])
    ->render();
```

### 2. Field Visibility System

**Core Properties** (in Field.php):
- `$visible` - boolean visibility flag
- `$visibilityCondition` - closure for custom logic
- `$permission` - required permission string
- `$roles` - array of required roles

**Methods**:
- `can(string $permission)` - Permission-based visibility
- `roles(array $roles)` - Role-based visibility
- `visibleWhen(callable $condition)` - Custom conditional logic
- `isVisible(?object $user)` - Check if field is visible to user

**Integration**: Works with `render()`, `toArray()`, `toJson()`

### 3. Performance Caching

**FormBuilder Properties**:
- `$cache` - Cache instance
- `$cacheTtl` - Time to live (default 3600)
- `$cacheEnabled` - Enable/disable flag
- `$user` - Current user for cache scoping

**Methods**:
- `cache(int $ttl = 3600)` - Enable caching
- `cached()` - Check if enabled
- `clearCache()` - Clear form cache
- `getCacheKey()` - Get unique cache key (user-scoped)

**Cache Scope**: Per-user, per-form automatic scoping

### 4. Hierarchical Organization

**Structure**: Form → Groups → Sections → Rows → Fields

**Properties** (in Field.php):
- `$group` - Top-level grouping identifier
- `$section` - Sub-group identifier
- `$row` - Row identifier for layout

**Methods** (in FormBuilder.php):
- `group(string $id, ?string $title, ?string $description)` - Start group
- `section(string $id, ?string $title, ?string $description)` - Start section
- `row(array $fields, ?string $id)` - Add fields in a row
- `divider(?string $label)` - Add visual separator
- `endGroup()` / `endSection()` - End current group/section

**Auto-assignment**: Fields added after `group()` or `section()` automatically inherit the context

### 5. Grid Layout System

**Properties**:
- `$width` - Field width (1-12 columns)
- `$totalColumns` - Total columns (default 12)
- `$defaultWidth` - Default width for all fields (default 6)

**Methods**:
- `col(int $width)` - Set field width
- `width(int $width, int $total = 12)` - Set width with custom total
- `defaultWidth(int $width)` - Set default for all fields

**Output**: Each field in `toArray()` includes `width`, `totalColumns`, `row` properties

### 6. Multi-Framework UI Support

**Supported Frameworks**:
- Bootstrap 5 (default)
- Bootstrap 4
- Tailwind CSS
- Custom themes

**View Structure**:
```
resources/views/
├── bootstrap5/
│   ├── form.blade.php
│   └── fields/*.blade.php
└── tailwind/
    ├── form.blade.php
    └── fields/*.blade.php
```

### 7. Client-Side Integration

**Methods**:
- `toArray(?object $user)` - Convert to array (respects visibility)
- `toJson(?object $user)` - Convert to JSON
- Output includes: name, type, label, validation, width, row, group, section, etc.

**Use Cases**: Vue.js, React, Angular API endpoints

## Data Flow

### Form Rendering Flow
```
1. FormBuilder::create() → Instantiate
2. ->add() / ->row() / ->group() → Build structure
3. ->forUser($user) → Set context (optional)
4. ->cache() → Enable caching (optional)
5. ->render($user) → Generate HTML
   ├─→ Check cache
   ├─→ Filter visible fields (isVisible($user))
   ├─→ Render via FormRenderer
   └─→ Cache output
```

### Validation Flow
```
1. Form defines validation rules via ->add()
2. Rules extracted to $rules array
3. Laravel validation applied on submit
4. Errors displayed via field templates
```

### Field Visibility Resolution
```
1. Check $visible property (true/false)
2. If $permission set → Check user->can($permission)
3. If $roles set → Check user->hasAnyRole($roles)
4. If $visibilityCondition → Execute closure($user, $record)
5. Return final boolean
```

## Common Patterns

### Pattern 1: User-Scoped Form with Caching
```php
$form = Form::create()
    ->forUser(auth()->user())
    ->cache(1800)
    ->add(Field::text('name'))
    ->add(Field::number('salary')->can('view-salary'));
    
return $form->toArray(); // Cached, filtered by visibility
```

### Pattern 2: Hierarchical Form
```php
$form = Form::create()
    ->group('basic', 'Basic Info')
        ->section('personal', 'Personal')
            ->row([
                Field::text('first_name')->col(6),
                Field::text('last_name')->col(6)
            ])
        ->endSection()
    ->endGroup()
    ->divider('Additional Details');
```

### Pattern 3: Responsive Grid Layout
```php
$form = Form::create()
    ->defaultWidth(6)
    ->row([
        Field::text('field1'),     // 6 columns
        Field::text('field2')      // 6 columns
    ])
    ->row([
        Field::text('city')->col(4),
        Field::text('state')->col(4),
        Field::text('zip')->col(4)
    ]);
```

## API Quick Reference

### FormBuilder Methods
```php
// Configuration
->action(string $url)
->method(string $method)
->files(bool $enabled = true)
->theme(string $framework)

// User & Permissions
->forUser(object $user)
->getUser()

// Caching
->cache(int $ttl = 3600)
->cached()
->withoutCache()
->clearCache()

// Field Management
->add(string $name, string $type, array $options = [])
->remove(string $name)
->has(string $name)
->get(string $name)

// Layout & Organization
->row(array $fields, ?string $id = null)
->group(string $id, ?string $title = null, ?string $description = null)
->section(string $id, ?string $title = null, ?string $description = null)
->endGroup()
->endSection()
->divider(?string $label = null)
->defaultWidth(int $width)

// Output
->render(?object $user = null)
->toArray(?object $user = null)
->toJson(?object $user = null)
->visibleFields(?object $user = null)
```

### Field Methods
```php
// Basic Properties
->label(string $label)
->value(mixed $value)
->placeholder(string $text)
->help(string $text)
->required(bool $required = true)
->disabled(bool $disabled = true)
->readonly(bool $readonly = true)

// Visibility Control
->can(string $permission)
->roles(array $roles)
->visible(bool $visible = true)
->hide()
->show()
->visibleWhen(callable $condition)

// Layout
->col(int $width)
->width(int $width, int $total = 12)
->row(string $rowId)
->group(string $groupId)
->section(string $sectionId)

// Validation
->rules(string|array $rules)
->messages(array $messages)

// Getters
->getName()
->getType()
->getLabel()
->getValue()
->getRules()
->isVisible(?object $user = null)
->getWidth()
->getRow()
->getGroup()
->getSection()
```

## Field Types Reference

### Text Input Fields
- `text` - Standard text input
- `email` - Email with validation
- `password` - Password input
- `number` - Numeric input
- `tel` - Telephone
- `url` - URL with validation
- `search` - Search input
- `hidden` - Hidden field
- `autocomplete` - Text input with autocomplete suggestions

### Date/Time Fields
- `date` - Date picker
- `time` - Time picker
- `datetime` - Combined date/time
- `datetime-local` - HTML5 datetime-local input
- `week` - Week picker
- `month` - Month picker
- `daterange` - Date range picker

### Selection Fields
- `select` - Dropdown (with multi-select support)
- `radio` - Radio buttons
- `checkbox` - Single checkbox
- `checkbox_group` - Multiple checkboxes as a group
- `toggle` - On/off switch
- `tags` - Tag input with autocomplete

### Text Areas & Editors
- `textarea` - Multi-line text
- `richtext` - WYSIWYG editor
- `markdown` - Markdown editor with preview
- `code` - Code editor with syntax highlighting
- `json` - JSON editor with validation

### Specialized Numeric Fields
- `currency` - Money input with currency symbol
- `percentage` - Percentage input (0-100)

### File/Media
- `file` - File upload
- `image` - Image upload with crop
- `gallery` - Multiple images

### Visual/Interactive
- `color` - Color picker
- `range` - Slider
- `rating` - Star rating
- `map` - Location/map picker
- `icon` - Icon picker

### Complex/Dynamic Fields
- `repeater` - Dynamic array of fields
- `keyvalue` - Key-value pair input

### Layout & Content
- `divider` - Visual separator
- `html` - Static HTML content

### Form Controls
- `submit` - Submit button
- `button` - Generic button
- `reset` - Reset button
### Visual/Interactive
- `color` - Color picker
- `range` - Range slider
- `rating` - Star rating
- `map` - Location picker

### Layout/Content
- `divider` - Visual separator
- `html` - Custom HTML
- `button` - Generic button
- `submit` - Submit button
- `reset` - Reset button

## Helper Functions

```php
// Quick form creation
form_quick(array $fields, array $options = [])

// Quick field creation
form_field(string $name, string $type, array $options = [])

// Convert to array/JSON
form_array(array $fields, array $options = [])
form_json(array $fields, array $options = [])

// Asset inclusion
form_include_assets(bool $css = true, bool $js = true)

// Form container
form_container(string $name)
form_container_quick(array $forms, array $options = [])
```

## Configuration (config/form.php)

```php
[
    'framework' => 'bootstrap5',           // UI framework
    'cache' => [
        'enabled' => true,
        'ttl' => 3600,
        'driver' => 'redis'
    ],
    'uploads' => [
        'disk' => 'public',
        'path' => 'uploads/forms',
        'max_size' => '10MB'
    ],
    'validation' => [
        'realtime' => true,
        'debounce' => 300
    ]
]
```

## Testing Patterns

```php
// Test form creation
$form = Form::create()->add('name', 'text');
$this->assertInstanceOf(FormBuilder::class, $form);

// Test field visibility
$user = User::factory()->create();
$field = Field::text('salary')->can('view-salary');
$this->assertTrue($field->isVisible($userWithPermission));
$this->assertFalse($field->isVisible($userWithoutPermission));

// Test caching
$form->cache(3600);
$this->assertTrue($form->cached());
$output1 = $form->render();
$output2 = $form->render();
// $output2 should be from cache
```

## Dependencies

**Required**:
- Laravel Framework 11+ or 12+
- PHP 8.2+
- Illuminate components: Support, Validation, View, Cache

**Optional**:
- TinyMCE (for richtext field)
- Google Maps API (for map field)

## Extension Points

### Custom Field Types
Extend `Field.php` and implement `getFieldType()`, `render()`

### Custom Themes
Create views in `resources/views/{theme}/`

### Custom Validators
Implement Laravel validation rules and pass to `->rules()`

### Custom Visibility Logic
Use `->visibleWhen(fn($user, $record) => /* custom logic */)

## AI Assistant Guidelines

When helping users with this package:

1. **Form Building**: Suggest fluent API chains with `->add()` or `->row()`
2. **Visibility**: Recommend `forUser()` + `can()`/`roles()`/`visibleWhen()`
3. **Performance**: Suggest `cache()` for complex forms or API endpoints
4. **Layout**: Recommend `row()` + `col()` for responsive grids
5. **Organization**: Suggest `group()` → `section()` → `row()` for complex forms
6. **Client-Side**: Use `toArray()` or `toJson()` for Vue/React/Angular
7. **Validation**: Use Laravel validation rules in `->rules()`

## Advanced Features (New in Latest Version)

### 1. Conditional Visibility with Operators

Fields can be shown/hidden based on other field values using declarative conditions:

```php
// Closure-based (traditional)
Field::text('credit_card')
    ->visibleWhen(fn($data) => $data['payment_method'] === 'card');

// Declarative (new)
Field::text('credit_card')
    ->visibleWhen('payment_method', '=', 'card');

// Multiple conditions (all must be true)
Field::text('discount_code')
    ->visibleWhen('membership', '=', 'premium')
    ->visibleWhen('total_amount', '>', 100);

// Supported operators: =, ==, ===, !=, !==, >, >=, <, <=, in, not_in, contains, starts_with, ends_with
Field::select('preferred_color')
    ->visibleWhen('interests', 'in', ['art', 'design']);
```

### 2. Conditional Required Fields

Make fields required based on other field values:

```php
Field::text('billing_address')
    ->requiredWhen('same_as_shipping', '!=', true);

Field::text('company_name')
    ->requiredWhen('account_type', '=', 'business');
```

### 3. Field Dependencies

Specify that a field depends on another field:

```php
Field::select('city')
    ->dependsOn(['country', 'state'])
    ->loadingText('Loading cities...');
```

### 4. Computed Fields

Create fields with calculated values:

```php
Field::text('total_price')
    ->computed(function($data) {
        return ($data['quantity'] ?? 0) * ($data['unit_price'] ?? 0);
    })
    ->readonly();
```

### 5. Tooltips and Examples

Provide inline help and example values:

```php
Field::text('api_key')
    ->tooltip('Found in your account settings under API Access')
    ->example('sk_live_4eC39HqLyjWDarjtT1zdp7dc');
```

### 6. Custom Validation Messages

Override default validation messages per field:

```php
Field::email('work_email')
    ->rules('required|email')
    ->validationMessage('required', 'Work email is mandatory')
    ->validationMessage('email', 'Please enter a valid work email address');
```

### 7. Loading States

Display loading text when field depends on async data:

```php
Field::select('cities')
    ->dependsOn('country')
    ->loadingText('Loading cities for selected country...');
```

### 8. Confirmation Dialogs

Require confirmation before changing field value:

```php
Field::checkbox('delete_account')
    ->confirmChange('Are you sure you want to delete your account? This cannot be undone.');
```

### 9. Change Tracking

Track changes to field values:

```php
Field::text('username')
    ->trackChanges(); // Will log old/new values
```

### 10. Column Layouts

Set field width in grid columns (out of 12):

```php
Field::text('first_name')->columns(6);  // 50% width
Field::text('last_name')->columns(6);   // 50% width
Field::textarea('bio')->columns(12);    // 100% width
```

## Common User Scenarios

**Scenario 1: "I need a registration form"**
→ Use `Form::create()` with text, email, password fields + validation

**Scenario 2: "Some fields should only show to admins"**
→ Use `->can('permission')` or `->roles(['admin'])`

**Scenario 3: "Form is slow with many fields"**
→ Enable caching with `->cache()`

**Scenario 4: "I need responsive layout"**
→ Use `->row([Field::text()->col(6), Field::email()->col(6)])` or `->columns(6)`

**Scenario 5: "Complex multi-section form"**
→ Use hierarchical structure: `->group()` → `->section()` → `->row()`

**Scenario 6: "Need JSON for Vue.js frontend"**
→ Use `->toArray()` or `->toJson()` in API endpoint

**Scenario 7: "Show field only when another field has specific value"**
→ Use `->visibleWhen('field', 'operator', 'value')`

**Scenario 8: "Calculate total price automatically"**
→ Use `->computed(fn($data) => $data['qty'] * $data['price'])`

## Output Examples

### toArray() Output Structure
```json
{
  "action": "/submit",
  "method": "POST",
  "fields": {
    "first_name": {
      "name": "first_name",
      "type": "text",
      "label": "First Name",
      "required": true,
      "validation": "required|string|max:255",
      "width": 6,
      "totalColumns": 12,
      "row": "row1",
      "group": "basic_info",
      "section": "personal",
      "tooltip": "Enter your legal first name",
      "example": "John",
      "columns": 6,
      "visibilityConditions": [],
      "requiredConditions": [],
      "dependsOn": [],
      "isComputed": false,
      "trackChanges": false
    }
  }
}
```

This AI context file helps language models understand the package architecture, patterns, and usage without analyzing all source code.

